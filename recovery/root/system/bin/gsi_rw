#!/system/bin/sh

perform_resize_and_unshare_blocks() {
    resize2fs "system.img" 7G
    e2fsck -E unshare_blocks "system.img"
    resize2fs -M "system.img"
}

process_user_selected_image() {
    read -p "Please enter the full path of the installed image, including the filename: " filepath

    directory=$(dirname "$filepath")
    filename=$(basename "$filepath")

    cd "$directory" || { echo "Could not change to the specified directory."; exit 1; }

    mv "$filename" "system.img"

    perform_resize_and_unshare_blocks

    mv "system.img" "$filename"
}

process_copied_system_image() {
    cp /dev/block/mapper/system /sdcard/system.img

    perform_resize_and_unshare_blocks
}

echo "Select an option:"
echo "1. Process the user-selected image."
echo "2. Process a copy of the installed system image."

read -p "Option: " option

case $option in
    1)
        process_user_selected_image
        ;;
    2)
        process_copied_system_image
        ;;
    *)
        echo "Invalid option."
        exit 1
        ;;
esac